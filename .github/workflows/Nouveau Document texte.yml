name: Cleanup Cache & Artifacts

on:
  workflow_dispatch:
    inputs:
      CLEANUP_TYPE:
        type: choice
        description: "Type de nettoyage"
        required: true
        default: all
        options:
          - all          # Tout nettoyer
          - ccache       # Seulement ccache
          - artifacts    # Seulement les artefacts
          - old-runs     # Anciennes ex√©cutions

      FILE_FILTER:
        type: choice
        description: "Filtre de configuration (pour ccache)"
        required: false
        default: all
        options:
          - all
          - android16-6.12-2025-06

      DAYS_OLD:
        type: number
        description: "Supprimer les √©l√©ments plus vieux que X jours"
        required: false
        default: 7

      DRY_RUN:
        type: boolean
        description: "Mode simulation (ne supprime rien)"
        required: true
        default: true

jobs:
  cleanup:
    name: üßπ Cleanup ${{ github.event.inputs.CLEANUP_TYPE }}
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: üîç Analyze Current Cache Usage
        id: analyze
        run: |
          echo "::group::üìä Cache Analysis"
          
          # Simuler l'analyse des caches (GitHub ne permet pas de lister directement)
          echo "Configuration cible: ${{ github.event.inputs.FILE_FILTER }}"
          echo "Type de nettoyage: ${{ github.event.inputs.CLEANUP_TYPE }}"
          echo "Anciennet√©: ${{ github.event.inputs.DAYS_OLD }} jours"
          echo "Mode simulation: ${{ github.event.inputs.DRY_RUN }}"
          
          # Calculer la date limite
          CUTOFF_DATE=$(date -d "${{ github.event.inputs.DAYS_OLD }} days ago" +%Y-%m-%d)
          echo "CUTOFF_DATE=$CUTOFF_DATE" >> $GITHUB_ENV
          
          echo "::endgroup::"

      - name: üóëÔ∏è Clean Ccache
        if: ${{ github.event.inputs.CLEANUP_TYPE == 'all' || github.event.inputs.CLEANUP_TYPE == 'ccache' }}
        uses: actions/github-script@v7
        with:
          script: |
            const dryRun = ${{ github.event.inputs.DRY_RUN }};
            const fileFilter = '${{ github.event.inputs.FILE_FILTER }}';
            const daysOld = ${{ github.event.inputs.DAYS_OLD }};
            
            console.log('üßπ Nettoyage des caches ccache...');
            console.log(`Mode: ${dryRun ? 'üîç SIMULATION' : 'üóëÔ∏è SUPPRESSION R√âELLE'}`);
            
            try {
              // Lister tous les caches
              const caches = await github.rest.actions.getActionsCacheList({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              let deletedCount = 0;
              let totalSize = 0;
              const cutoffDate = new Date();
              cutoffDate.setDate(cutoffDate.getDate() - daysOld);
              
              for (const cache of caches.data.actions_caches) {
                const cacheDate = new Date(cache.created_at);
                const matchesFilter = fileFilter === 'all' || cache.key.includes(fileFilter);
                const isOld = cacheDate < cutoffDate;
                const isCcache = cache.key.includes('ccache');
                
                if (isCcache && matchesFilter && isOld) {
                  console.log(`üì¶ Cache trouv√©: ${cache.key}`);
                  console.log(`   Taille: ${(cache.size_in_bytes / 1024 / 1024).toFixed(2)} MB`);
                  console.log(`   Cr√©√© le: ${cache.created_at}`);
                  console.log(`   √Çge: ${Math.floor((Date.now() - cacheDate) / (1000 * 60 * 60 * 24))} jours`);
                  
                  totalSize += cache.size_in_bytes;
                  
                  if (!dryRun) {
                    try {
                      await github.rest.actions.deleteActionsCacheById({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        cache_id: cache.id
                      });
                      console.log(`   ‚úÖ Supprim√©`);
                      deletedCount++;
                    } catch (error) {
                      console.log(`   ‚ùå Erreur: ${error.message}`);
                    }
                  } else {
                    console.log(`   üîç [SIMULATION] Serait supprim√©`);
                    deletedCount++;
                  }
                  console.log('');
                }
              }
              
              console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
              console.log(`üìä R√©sum√© du nettoyage ccache:`);
              console.log(`   Caches ${dryRun ? '√† supprimer' : 'supprim√©s'}: ${deletedCount}`);
              console.log(`   Espace ${dryRun ? '√† lib√©rer' : 'lib√©r√©'}: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
              console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
              
              core.setOutput('ccache_deleted', deletedCount);
              core.setOutput('ccache_size', totalSize);
              
            } catch (error) {
              console.error('‚ùå Erreur lors du nettoyage ccache:', error);
              core.setFailed(error.message);
            }

      - name: üóëÔ∏è Clean Build Artifacts
        if: ${{ github.event.inputs.CLEANUP_TYPE == 'all' || github.event.inputs.CLEANUP_TYPE == 'artifacts' }}
        uses: actions/github-script@v7
        with:
          script: |
            const dryRun = ${{ github.event.inputs.DRY_RUN }};
            const daysOld = ${{ github.event.inputs.DAYS_OLD }};
            
            console.log('üßπ Nettoyage des artefacts de build...');
            console.log(`Mode: ${dryRun ? 'üîç SIMULATION' : 'üóëÔ∏è SUPPRESSION R√âELLE'}`);
            
            try {
              const artifacts = await github.rest.actions.listArtifactsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              let deletedCount = 0;
              let totalSize = 0;
              const cutoffDate = new Date();
              cutoffDate.setDate(cutoffDate.getDate() - daysOld);
              
              for (const artifact of artifacts.data.artifacts) {
                const artifactDate = new Date(artifact.created_at);
                const isOld = artifactDate < cutoffDate;
                
                if (isOld) {
                  console.log(`üì¶ Artefact trouv√©: ${artifact.name}`);
                  console.log(`   Taille: ${(artifact.size_in_bytes / 1024 / 1024).toFixed(2)} MB`);
                  console.log(`   Cr√©√© le: ${artifact.created_at}`);
                  console.log(`   √Çge: ${Math.floor((Date.now() - artifactDate) / (1000 * 60 * 60 * 24))} jours`);
                  
                  totalSize += artifact.size_in_bytes;
                  
                  if (!dryRun) {
                    try {
                      await github.rest.actions.deleteArtifact({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        artifact_id: artifact.id
                      });
                      console.log(`   ‚úÖ Supprim√©`);
                      deletedCount++;
                    } catch (error) {
                      console.log(`   ‚ùå Erreur: ${error.message}`);
                    }
                  } else {
                    console.log(`   üîç [SIMULATION] Serait supprim√©`);
                    deletedCount++;
                  }
                  console.log('');
                }
              }
              
              console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
              console.log(`üìä R√©sum√© du nettoyage des artefacts:`);
              console.log(`   Artefacts ${dryRun ? '√† supprimer' : 'supprim√©s'}: ${deletedCount}`);
              console.log(`   Espace ${dryRun ? '√† lib√©rer' : 'lib√©r√©'}: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
              console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
              
              core.setOutput('artifacts_deleted', deletedCount);
              core.setOutput('artifacts_size', totalSize);
              
            } catch (error) {
              console.error('‚ùå Erreur lors du nettoyage des artefacts:', error);
              core.setFailed(error.message);
            }

      - name: üóëÔ∏è Clean Old Workflow Runs
        if: ${{ github.event.inputs.CLEANUP_TYPE == 'all' || github.event.inputs.CLEANUP_TYPE == 'old-runs' }}
        uses: actions/github-script@v7
        with:
          script: |
            const dryRun = ${{ github.event.inputs.DRY_RUN }};
            const daysOld = ${{ github.event.inputs.DAYS_OLD }};
            
            console.log('üßπ Nettoyage des anciennes ex√©cutions de workflow...');
            console.log(`Mode: ${dryRun ? 'üîç SIMULATION' : 'üóëÔ∏è SUPPRESSION R√âELLE'}`);
            
            try {
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                status: 'completed'
              });
              
              let deletedCount = 0;
              const cutoffDate = new Date();
              cutoffDate.setDate(cutoffDate.getDate() - daysOld);
              
              for (const run of runs.data.workflow_runs) {
                const runDate = new Date(run.created_at);
                const isOld = runDate < cutoffDate;
                
                // Ne pas supprimer le workflow actuel
                if (isOld && run.id !== context.runId) {
                  console.log(`üèÉ Ex√©cution trouv√©e: ${run.name} (#${run.run_number})`);
                  console.log(`   Statut: ${run.conclusion}`);
                  console.log(`   Cr√©√© le: ${run.created_at}`);
                  console.log(`   √Çge: ${Math.floor((Date.now() - runDate) / (1000 * 60 * 60 * 24))} jours`);
                  
                  if (!dryRun) {
                    try {
                      await github.rest.actions.deleteWorkflowRun({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        run_id: run.id
                      });
                      console.log(`   ‚úÖ Supprim√©`);
                      deletedCount++;
                    } catch (error) {
                      console.log(`   ‚ùå Erreur: ${error.message}`);
                    }
                  } else {
                    console.log(`   üîç [SIMULATION] Serait supprim√©`);
                    deletedCount++;
                  }
                  console.log('');
                }
              }
              
              console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
              console.log(`üìä R√©sum√© du nettoyage des ex√©cutions:`);
              console.log(`   Ex√©cutions ${dryRun ? '√† supprimer' : 'supprim√©es'}: ${deletedCount}`);
              console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
              
              core.setOutput('runs_deleted', deletedCount);
              
            } catch (error) {
              console.error('‚ùå Erreur lors du nettoyage des ex√©cutions:', error);
              core.setFailed(error.message);
            }

      - name: üìä Cleanup Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # üßπ Rapport de nettoyage

          ## ‚öôÔ∏è Configuration

          | Param√®tre | Valeur |
          |-----------|--------|
          | **Type de nettoyage** | ${{ github.event.inputs.CLEANUP_TYPE }} |
          | **Filtre de configuration** | ${{ github.event.inputs.FILE_FILTER }} |
          | **Anciennet√©** | ${{ github.event.inputs.DAYS_OLD }} jours |
          | **Mode** | ${{ github.event.inputs.DRY_RUN == 'true' && 'üîç Simulation' || 'üóëÔ∏è Suppression r√©elle' }} |
          | **Date limite** | ${{ env.CUTOFF_DATE }} |

          ## üìä R√©sultats

          EOF

          if [ "${{ github.event.inputs.CLEANUP_TYPE }}" == "all" ] || [ "${{ github.event.inputs.CLEANUP_TYPE }}" == "ccache" ]; then
            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ### üíæ Ccache
          - Caches trait√©s: Voir les logs ci-dessus
          - Espace lib√©r√©: Voir les logs ci-dessus

          EOF
          fi

          if [ "${{ github.event.inputs.CLEANUP_TYPE }}" == "all" ] || [ "${{ github.event.inputs.CLEANUP_TYPE }}" == "artifacts" ]; then
            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ### üì¶ Artefacts
          - Artefacts trait√©s: Voir les logs ci-dessus
          - Espace lib√©r√©: Voir les logs ci-dessus

          EOF
          fi

          if [ "${{ github.event.inputs.CLEANUP_TYPE }}" == "all" ] || [ "${{ github.event.inputs.CLEANUP_TYPE }}" == "old-runs" ]; then
            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ### üèÉ Ex√©cutions de workflow
          - Ex√©cutions trait√©es: Voir les logs ci-dessus

          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ---

          ${{ github.event.inputs.DRY_RUN == 'true' && '‚ö†Ô∏è **Mode simulation activ√©** - Aucune suppression effectu√©e' || '‚úÖ **Nettoyage termin√© avec succ√®s!**' }}
          EOF
